#!/bin/bash
set -e

# Script to download all ComfyUI models at the start of a session
echo "=== ComfyUI Model Downloader ==="

# Get the directory where the script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Default ComfyUI directory is current directory, but can be specified as argument
COMFYUI_DIR=${1:-$(pwd)}

# Determine optimal number of parallel downloads based on CPU cores
# Use 75% of available cores by default, minimum 4, maximum 32
AVAILABLE_CORES=$(nproc)
MAX_PARALLEL_DOWNLOADS=$((AVAILABLE_CORES * 3 / 4))
MAX_PARALLEL_DOWNLOADS=$((MAX_PARALLEL_DOWNLOADS < 4 ? 4 : MAX_PARALLEL_DOWNLOADS))
MAX_PARALLEL_DOWNLOADS=$((MAX_PARALLEL_DOWNLOADS > 32 ? 32 : MAX_PARALLEL_DOWNLOADS))

# Error handling function
handle_error() {
  echo "ERROR: $1"
  echo "Download failed. Please check the error message above."
  exit 1
}

# Function to show progress
show_progress() {
  local msg="$1"
  echo ""
  echo "---------------------------------------------------"
  echo "  $msg"
  echo "---------------------------------------------------"
}

# Check if the specified directory is a ComfyUI directory
if [ ! -d "$COMFYUI_DIR/models" ] || [ ! -d "$COMFYUI_DIR/comfy" ]; then
  echo "ERROR: The specified directory does not appear to be a ComfyUI installation."
  echo "Please specify a valid ComfyUI directory as an argument."
  exit 1
fi

show_progress "Creating model directories"
# Create required directories
mkdir -p "$COMFYUI_DIR/models/checkpoints"
mkdir -p "$COMFYUI_DIR/models/clip_vision"
mkdir -p "$COMFYUI_DIR/models/vae"
mkdir -p "$COMFYUI_DIR/models/loras"
mkdir -p "$COMFYUI_DIR/models/controlnet"
mkdir -p "$COMFYUI_DIR/models/upscale_models"
mkdir -p "$COMFYUI_DIR/models/facerestore_models"
mkdir -p "$COMFYUI_DIR/models/ipadapter"
mkdir -p "$COMFYUI_DIR/models/instantid/antelopev2"
mkdir -p "$COMFYUI_DIR/models/insightface"
mkdir -p "$COMFYUI_DIR/models/ultralytics/bbox"
mkdir -p "$COMFYUI_DIR/models/sams"
mkdir -p "$COMFYUI_DIR/models/reactor/faces"
mkdir -p "$COMFYUI_DIR/models/reswapper"

show_progress "Starting model downloads"
echo "Using $MAX_PARALLEL_DOWNLOADS parallel downloads (based on $AVAILABLE_CORES CPU cores)"
cd "$COMFYUI_DIR"

# Check if download list exists
DOWNLOAD_LIST="$SCRIPT_DIR/model_downloads.txt"
if [ ! -f "$DOWNLOAD_LIST" ]; then
  echo "ERROR: $DOWNLOAD_LIST not found!"
  echo "Please ensure the model_downloads.txt file is in the same directory as this script."
  exit 1
fi

# Create a temporary file to hold download commands
DOWNLOAD_COMMANDS_FILE=$(mktemp)

# Read the download list and create wget commands
while read -r line; do
  # Skip empty lines and comments
  if [[ -z "$line" || "$line" == \#* ]]; then
    # If it's a comment, print it as a section header
    if [[ "$line" == \#* ]]; then
      echo ""
      echo "$line"
    fi
    continue
  fi

  # Split the line by pipe character to get URL and destination
  url=$(echo "$line" | cut -d'|' -f1)
  dest=$(echo "$line" | cut -d'|' -f2)

  # Get filename for progress tracking
  filename=$(basename "$url" | cut -d'?' -f1)

  # Add the download command to our commands file
  echo "cd \"$COMFYUI_DIR\" && wget -q -c \"$url\" -P \"./$(echo $dest)\" --show-progress && echo \"Downloaded: \$filename\"" >>"$DOWNLOAD_COMMANDS_FILE"
done <"$DOWNLOAD_LIST"

# Count total downloads
TOTAL_DOWNLOADS=$(wc -l <"$DOWNLOAD_COMMANDS_FILE")
echo "Starting $TOTAL_DOWNLOADS downloads with $MAX_PARALLEL_DOWNLOADS parallel processes"

# Execute downloads with xargs for better parallelism
cat "$DOWNLOAD_COMMANDS_FILE" | xargs -P "$MAX_PARALLEL_DOWNLOADS" -I {} bash -c "{}"

# Clean up
rm "$DOWNLOAD_COMMANDS_FILE"

# ====================================================
# IPAdapter Special Case Handling
# ====================================================
# This section handles models that require specific renaming for the IPAdapter's Unified Loader

show_progress "Downloading IPAdapter models that require special naming"

# Array of source URLs and destination filenames
declare -a ipa_special_models=(
  "https://huggingface.co/h94/IP-Adapter/resolve/main/models/image_encoder/model.safetensors|models/clip_vision/CLIP-ViT-H-14-laion2B-s32B-b79K.safetensors"
  "https://huggingface.co/h94/IP-Adapter/resolve/main/sdxl_models/image_encoder/model.safetensors|models/clip_vision/CLIP-ViT-bigG-14-laion2B-39B-b160k.safetensors"
  "https://huggingface.co/Kwai-Kolors/Kolors-IP-Adapter-Plus/resolve/main/image_encoder/pytorch_model.bin|models/clip_vision/clip-vit-large-patch14-336.bin"
  "https://huggingface.co/Kwai-Kolors/Kolors-IP-Adapter-Plus/resolve/main/ip_adapter_plus_general.bin|models/ipadapter/Kolors-IP-Adapter-Plus.bin"
  "https://huggingface.co/Kwai-Kolors/Kolors-IP-Adapter-FaceID-Plus/resolve/main/ipa-faceid-plus.bin|models/ipadapter/Kolors-IP-Adapter-FaceID-Plus.bin"
)

# Create a temporary file for download commands
IPA_DOWNLOAD_COMMANDS_FILE=$(mktemp)

# Process each URL and destination pair
for pair in "${ipa_special_models[@]}"; do
  url=$(echo "$pair" | cut -d'|' -f1)
  dest=$(echo "$pair" | cut -d'|' -f2)

  # Get filename for better logging
  filename=$(basename "$dest")

  # Add the download command to our commands file
  echo "cd \"$COMFYUI_DIR\" && wget -q -c \"$url\" -O \"./$(echo $dest)\" --show-progress && echo \"Downloaded and renamed: $filename\"" >>"$IPA_DOWNLOAD_COMMANDS_FILE"
done

# Count total special downloads
TOTAL_IPA_DOWNLOADS=$(wc -l <"$IPA_DOWNLOAD_COMMANDS_FILE")
echo "Starting $TOTAL_IPA_DOWNLOADS special downloads with $MAX_PARALLEL_DOWNLOADS parallel processes"

# Execute downloads with xargs
cat "$IPA_DOWNLOAD_COMMANDS_FILE" | xargs -P "$MAX_PARALLEL_DOWNLOADS" -I {} bash -c "{}"

# Clean up
rm "$IPA_DOWNLOAD_COMMANDS_FILE"

# ====================================================
# ReActor Models Installation
# ====================================================
show_progress "Installing ReActor models"

# Create temporary directory for the repository
TEMP_DIR="$COMFYUI_DIR/temp_reactor_repo"
echo "Creating temporary directory at $TEMP_DIR"
rm -rf "$TEMP_DIR" # Clean up any existing temp dir
mkdir -p "$TEMP_DIR"

# Check if git-lfs is installed
if ! command -v git-lfs &>/dev/null; then
  echo "ERROR: Git LFS is not installed. This is required for ReActor models."
  echo "Please install Git LFS manually: https://git-lfs.github.com/"
  echo "After installing, run: git lfs install"
  echo "Skipping ReActor models installation..."
else
  echo "Git LFS is installed. Attempting to initialize..."
  # Initialize Git LFS with verbose output
  git lfs install --verbose
  echo "Git LFS initialization completed with status: $?"

  # Clone the repository with more verbose output
  echo "Cloning ReActor models repository (this may take some time)..."
  echo "Using repository: https://huggingface.co/datasets/Gourieff/ReActor"

  # Try cloning with more detailed output
  if git clone --verbose https://huggingface.co/datasets/Gourieff/ReActor "$TEMP_DIR" 2>&1; then
    echo "Repository cloned successfully."

    # Verify directory structure
    echo "Checking repository structure..."
    find "$TEMP_DIR" -type d -maxdepth 2 | sort

    # Verify if models directory exists and what it contains
    if [ -d "$TEMP_DIR/models" ]; then
      echo "Models directory found. Contents:"
      find "$TEMP_DIR/models" -type f -maxdepth 1 | sort

      # Copy inswapper models to insightface directory
      echo "Copying inswapper models..."
      if [ -f "$TEMP_DIR/models/inswapper_128.onnx" ]; then
        echo "Found inswapper_128.onnx, copying..."
        cp -v "$TEMP_DIR/models/inswapper_128.onnx" "$COMFYUI_DIR/models/insightface/"
      else
        echo "ERROR: inswapper_128.onnx not found in $TEMP_DIR/models/"
      fi

      if [ -f "$TEMP_DIR/models/inswapper_128_fp16.onnx" ]; then
        echo "Found inswapper_128_fp16.onnx, copying..."
        cp -v "$TEMP_DIR/models/inswapper_128_fp16.onnx" "$COMFYUI_DIR/models/insightface/"
      else
        echo "ERROR: inswapper_128_fp16.onnx not found in $TEMP_DIR/models/"
      fi

      # Copy reswapper models with explicit checks
      echo "Copying reswapper models..."
      if [ -f "$TEMP_DIR/models/reswapper_128.onnx" ]; then
        echo "Found reswapper_128.onnx, copying..."
        cp -v "$TEMP_DIR/models/reswapper_128.onnx" "$COMFYUI_DIR/models/reswapper/"
      else
        echo "WARNING: reswapper_128.onnx not found in $TEMP_DIR/models/"
      fi

      if [ -f "$TEMP_DIR/models/reswapper_256.onnx" ]; then
        echo "Found reswapper_256.onnx, copying..."
        cp -v "$TEMP_DIR/models/reswapper_256.onnx" "$COMFYUI_DIR/models/reswapper/"
      else
        echo "WARNING: reswapper_256.onnx not found in $TEMP_DIR/models/"
      fi

      # Check face restoration models directory
      echo "Checking face restoration models..."
      if [ -d "$TEMP_DIR/models/facerestore_models" ]; then
        echo "Face restoration models directory found. Contents:"
        find "$TEMP_DIR/models/facerestore_models" -type f | sort
        echo "Copying face restoration models..."
        cp -v "$TEMP_DIR/models/facerestore_models/"* "$COMFYUI_DIR/models/facerestore_models/" 2>/dev/null || echo "Warning: No files copied from facerestore_models"
      else
        echo "WARNING: facerestore_models directory not found in $TEMP_DIR/models/"
      fi

      # Check detection/bbox directory
      echo "Checking face detection model..."
      if [ -f "$TEMP_DIR/models/detection/bbox/face_yolov8m.pt" ]; then
        echo "Found face_yolov8m.pt, copying..."
        cp -v "$TEMP_DIR/models/detection/bbox/face_yolov8m.pt" "$COMFYUI_DIR/models/ultralytics/bbox/"
      else
        echo "WARNING: Directory structure for detection models is different than expected."
        echo "Looking for detection models in alternate locations..."
        find "$TEMP_DIR" -name "face_yolov8m.pt" | while read f; do
          echo "Found at $f, copying..."
          cp -v "$f" "$COMFYUI_DIR/models/ultralytics/bbox/"
        done
      fi

      # Check SAMs directory
      echo "Checking SAM models..."
      if [ -d "$TEMP_DIR/models/sams" ]; then
        echo "SAM models directory found. Contents:"
        find "$TEMP_DIR/models/sams" -type f | sort
        echo "Copying SAM models..."
        cp -v "$TEMP_DIR/models/sams/"* "$COMFYUI_DIR/models/sams/" 2>/dev/null || echo "Warning: No files copied from sams directory"
      else
        echo "WARNING: sams directory not found in $TEMP_DIR/models/"
      fi

      # Check buffalo_l.zip
      echo "Checking buffalo_l model..."
      if [ -f "$TEMP_DIR/models/buffalo_l.zip" ]; then
        echo "Found buffalo_l.zip, extracting..."
        unzip -v "$TEMP_DIR/models/buffalo_l.zip" -d "$COMFYUI_DIR/models/insightface/" || echo "Warning: Failed to extract buffalo_l.zip"
      else
        echo "WARNING: buffalo_l.zip not found in $TEMP_DIR/models/"
        echo "Looking for buffalo_l model in alternate formats or locations..."
        find "$TEMP_DIR" -name "buffalo_l*" | while read f; do
          echo "Found at $f, copying..."
          if [[ "$f" == *.zip ]]; then
            unzip -v "$f" -d "$COMFYUI_DIR/models/insightface/" || echo "Warning: Failed to extract $(basename $f)"
          else
            cp -rv "$f" "$COMFYUI_DIR/models/insightface/"
          fi
        done
      fi
    else
      echo "ERROR: Models directory not found in the cloned repository."
      echo "Directory contents:"
      ls -la "$TEMP_DIR"
    fi

    # Clean up
    echo "Cleaning up temporary ReActor files..."
    rm -rf "$TEMP_DIR"

  else
    echo "ERROR: Failed to clone ReActor repository."
    echo "Try running this command manually to see detailed errors:"
    echo "git clone https://huggingface.co/datasets/Gourieff/ReActor $TEMP_DIR"
  fi
fi

# Check if any ReActor models were installed
echo "Checking if ReActor models were successfully installed..."
if [ -f "$COMFYUI_DIR/models/insightface/inswapper_128.onnx" ]; then
  echo "✓ ReActor models installed successfully"
else
  echo "⚠️ No ReActor models were installed. You may need to install them manually."
  echo "Visit: https://huggingface.co/datasets/Gourieff/ReActor for downloads"
fi

show_progress "Download Complete!"
echo "All models have been downloaded to $COMFYUI_DIR/models/"
echo "IPAdapter models have been properly renamed for the Unified Loader."
echo "ReActor models have been installed."
echo "You can now start using ComfyUI with all the downloaded models."
