#!/bin/bash
set -e

# Script to download all ComfyUI models at the start of a session
echo "=== ComfyUI Model Downloader ==="

# Get the directory where the script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Default ComfyUI directory is current directory, but can be specified as argument
COMFYUI_DIR=${1:-$(pwd)}

# Determine optimal number of parallel downloads based on CPU cores
# Use 75% of available cores by default, minimum 4, maximum 32
AVAILABLE_CORES=$(nproc)
MAX_PARALLEL_DOWNLOADS=$((AVAILABLE_CORES * 3 / 4))
MAX_PARALLEL_DOWNLOADS=$((MAX_PARALLEL_DOWNLOADS < 4 ? 4 : MAX_PARALLEL_DOWNLOADS))
MAX_PARALLEL_DOWNLOADS=$((MAX_PARALLEL_DOWNLOADS > 32 ? 32 : MAX_PARALLEL_DOWNLOADS))

# Error handling function
handle_error() {
  echo "ERROR: $1"
  echo "Download failed. Please check the error message above."
  exit 1
}

# Function to show progress
show_progress() {
  local msg="$1"
  echo ""
  echo "---------------------------------------------------"
  echo "  $msg"
  echo "---------------------------------------------------"
}

# Check if the specified directory is a ComfyUI directory
if [ ! -d "$COMFYUI_DIR/models" ] || [ ! -d "$COMFYUI_DIR/comfy" ]; then
  echo "ERROR: The specified directory does not appear to be a ComfyUI installation."
  echo "Please specify a valid ComfyUI directory as an argument."
  exit 1
fi

show_progress "Creating model directories"
# Create required directories
mkdir -p "$COMFYUI_DIR/models/checkpoints"
mkdir -p "$COMFYUI_DIR/models/clip_vision"
mkdir -p "$COMFYUI_DIR/models/vae"
mkdir -p "$COMFYUI_DIR/models/loras"
mkdir -p "$COMFYUI_DIR/models/controlnet"
mkdir -p "$COMFYUI_DIR/models/upscale_models"
mkdir -p "$COMFYUI_DIR/models/facerestore_models"
mkdir -p "$COMFYUI_DIR/models/ipadapter"
mkdir -p "$COMFYUI_DIR/models/instantid/antelopev2"
mkdir -p "$COMFYUI_DIR/models/insightface"
mkdir -p "$COMFYUI_DIR/models/ultralytics/bbox"
mkdir -p "$COMFYUI_DIR/models/sams"
mkdir -p "$COMFYUI_DIR/models/reactor/faces"
mkdir -p "$COMFYUI_DIR/models/reswapper"

show_progress "Starting model downloads"
echo "Using $MAX_PARALLEL_DOWNLOADS parallel downloads (based on $AVAILABLE_CORES CPU cores)"
cd "$COMFYUI_DIR"

# Check if download list exists
DOWNLOAD_LIST="$SCRIPT_DIR/model_downloads.txt"
if [ ! -f "$DOWNLOAD_LIST" ]; then
  echo "ERROR: $DOWNLOAD_LIST not found!"
  echo "Please ensure the model_downloads.txt file is in the same directory as this script."
  exit 1
fi

# Create a temporary file to hold download commands
DOWNLOAD_COMMANDS_FILE=$(mktemp)

# Read the download list and create wget commands
while read -r line; do
  # Skip empty lines and comments
  if [[ -z "$line" || "$line" == \#* ]]; then
    # If it's a comment, print it as a section header
    if [[ "$line" == \#* ]]; then
      echo ""
      echo "$line"
    fi
    continue
  fi

  # Split the line by pipe character to get URL and destination
  url=$(echo "$line" | cut -d'|' -f1)
  dest=$(echo "$line" | cut -d'|' -f2)

  # Get filename for progress tracking
  filename=$(basename "$url" | cut -d'?' -f1)

  # Add the download command to our commands file
  echo "cd \"$COMFYUI_DIR\" && wget -q -c \"$url\" -P \"./$(echo $dest)\" --show-progress && echo \"Downloaded: \$filename\"" >>"$DOWNLOAD_COMMANDS_FILE"
done <"$DOWNLOAD_LIST"

# Count total downloads
TOTAL_DOWNLOADS=$(wc -l <"$DOWNLOAD_COMMANDS_FILE")
echo "Starting $TOTAL_DOWNLOADS downloads with $MAX_PARALLEL_DOWNLOADS parallel processes"

# Execute downloads with xargs for better parallelism
cat "$DOWNLOAD_COMMANDS_FILE" | xargs -P "$MAX_PARALLEL_DOWNLOADS" -I {} bash -c "{}"

# Clean up
rm "$DOWNLOAD_COMMANDS_FILE"

# ====================================================
# IPAdapter Special Case Handling
# ====================================================
# This section handles models that require specific renaming for the IPAdapter's Unified Loader

show_progress "Downloading IPAdapter models that require special naming"

# Array of source URLs and destination filenames
declare -a ipa_special_models=(
  "https://huggingface.co/h94/IP-Adapter/resolve/main/models/image_encoder/model.safetensors|models/clip_vision/CLIP-ViT-H-14-laion2B-s32B-b79K.safetensors"
  "https://huggingface.co/h94/IP-Adapter/resolve/main/sdxl_models/image_encoder/model.safetensors|models/clip_vision/CLIP-ViT-bigG-14-laion2B-39B-b160k.safetensors"
  "https://huggingface.co/Kwai-Kolors/Kolors-IP-Adapter-Plus/resolve/main/image_encoder/pytorch_model.bin|models/clip_vision/clip-vit-large-patch14-336.bin"
  "https://huggingface.co/Kwai-Kolors/Kolors-IP-Adapter-Plus/resolve/main/ip_adapter_plus_general.bin|models/ipadapter/Kolors-IP-Adapter-Plus.bin"
  "https://huggingface.co/Kwai-Kolors/Kolors-IP-Adapter-FaceID-Plus/resolve/main/ipa-faceid-plus.bin|models/ipadapter/Kolors-IP-Adapter-FaceID-Plus.bin"
)

# Create a temporary file for download commands
IPA_DOWNLOAD_COMMANDS_FILE=$(mktemp)

# Process each URL and destination pair
for pair in "${ipa_special_models[@]}"; do
  url=$(echo "$pair" | cut -d'|' -f1)
  dest=$(echo "$pair" | cut -d'|' -f2)

  # Get filename for better logging
  filename=$(basename "$dest")

  # Add the download command to our commands file
  echo "cd \"$COMFYUI_DIR\" && wget -q -c \"$url\" -O \"./$(echo $dest)\" --show-progress && echo \"Downloaded and renamed: $filename\"" >>"$IPA_DOWNLOAD_COMMANDS_FILE"
done

# Count total special downloads
TOTAL_IPA_DOWNLOADS=$(wc -l <"$IPA_DOWNLOAD_COMMANDS_FILE")
echo "Starting $TOTAL_IPA_DOWNLOADS special downloads with $MAX_PARALLEL_DOWNLOADS parallel processes"

# Execute downloads with xargs
cat "$IPA_DOWNLOAD_COMMANDS_FILE" | xargs -P "$MAX_PARALLEL_DOWNLOADS" -I {} bash -c "{}"

# Clean up
rm "$IPA_DOWNLOAD_COMMANDS_FILE"

# ====================================================
# ReActor Models Installation
# ====================================================
show_progress "Installing ReActor models"

# Create temporary directory for the repository
TEMP_DIR="$COMFYUI_DIR/temp_reactor_repo"
mkdir -p "$TEMP_DIR"

# Check if git-lfs is installed
if ! command -v git-lfs &>/dev/null; then
  echo "Git LFS is not installed. Attempting to install..."
  if command -v apt-get &>/dev/null; then
    sudo apt-get update && sudo apt-get install -y git-lfs
  elif command -v yum &>/dev/null; then
    sudo yum install -y git-lfs
  elif command -v brew &>/dev/null; then
    brew install git-lfs
  else
    echo "WARNING: Could not automatically install Git LFS. Some large files may not download correctly."
    echo "Please install Git LFS manually: https://git-lfs.github.com/"
  fi
fi

# Initialize Git LFS
git lfs install

# Clone the repository
echo "Cloning ReActor models repository (this may take some time)..."
git clone https://huggingface.co/datasets/Gourieff/ReActor "$TEMP_DIR"

if [ ! -d "$TEMP_DIR/models" ]; then
  echo "Warning: Failed to clone ReActor repository or models directory not found"
  echo "Continuing with regular downloads..."
else
  # Copy inswapper models to insightface directory
  echo "Copying inswapper models..."
  cp "$TEMP_DIR/models/inswapper_128.onnx" "$COMFYUI_DIR/models/insightface/" 2>/dev/null || echo "Warning: inswapper_128.onnx not found"
  cp "$TEMP_DIR/models/inswapper_128_fp16.onnx" "$COMFYUI_DIR/models/insightface/" 2>/dev/null || echo "Warning: inswapper_128_fp16.onnx not found"

  # Copy reswapper models
  echo "Copying reswapper models..."
  if [ -f "$TEMP_DIR/models/reswapper_128.onnx" ]; then
    cp "$TEMP_DIR/models/reswapper_128.onnx" "$COMFYUI_DIR/models/reswapper/"
  fi
  if [ -f "$TEMP_DIR/models/reswapper_256.onnx" ]; then
    cp "$TEMP_DIR/models/reswapper_256.onnx" "$COMFYUI_DIR/models/reswapper/"
  fi

  # Copy face restoration models
  echo "Copying face restoration models..."
  if [ -d "$TEMP_DIR/models/facerestore_models" ]; then
    cp "$TEMP_DIR/models/facerestore_models/"* "$COMFYUI_DIR/models/facerestore_models/" 2>/dev/null
  fi

  # Copy face detection model
  echo "Copying face detection model..."
  if [ -f "$TEMP_DIR/models/detection/bbox/face_yolov8m.pt" ]; then
    cp "$TEMP_DIR/models/detection/bbox/face_yolov8m.pt" "$COMFYUI_DIR/models/ultralytics/bbox/"
  fi

  # Copy SAM models
  echo "Copying SAM models..."
  if [ -d "$TEMP_DIR/models/sams" ]; then
    cp "$TEMP_DIR/models/sams/"* "$COMFYUI_DIR/models/sams/" 2>/dev/null
  fi

  # Extract buffalo_l.zip if needed for insightface
  echo "Extracting buffalo_l model..."
  if [ -f "$TEMP_DIR/models/buffalo_l.zip" ]; then
    unzip -o "$TEMP_DIR/models/buffalo_l.zip" -d "$COMFYUI_DIR/models/insightface/" || echo "Warning: Failed to extract buffalo_l.zip"
  fi

  # Clean up
  echo "Cleaning up temporary ReActor files..."
  rm -rf "$TEMP_DIR"
fi

show_progress "Download Complete!"
echo "All models have been downloaded to $COMFYUI_DIR/models/"
echo "IPAdapter models have been properly renamed for the Unified Loader."
echo "ReActor models have been installed."
echo "You can now start using ComfyUI with all the downloaded models."
