#!/bin/bash
set -e

# Get the directory where the script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Default ComfyUI directory is current directory, but can be specified as argument
COMFYUI_DIR=${1:-$(pwd)}

# Error handling function
handle_error() {
  echo "ERROR: $1"
  echo "Download failed. Please check the error message above."
  exit 1
}

# Function to show progress
show_progress() {
  local msg="$1"
  echo ""
  echo "---------------------------------------------------"
  echo "  $msg"
  echo "---------------------------------------------------"
}

# Check if the specified directory is a ComfyUI directory
if [ ! -d "$COMFYUI_DIR/models" ] || [ ! -d "$COMFYUI_DIR/comfy" ]; then
  echo "ERROR: The specified directory does not appear to be a ComfyUI installation."
  echo "Please specify a valid ComfyUI directory as an argument."
  exit 1
fi


cd "$COMFYUI_DIR"

# ====================================================
# ReActor Models Installation
# ====================================================
show_progress "Installing ReActor models"

# Create temporary directory for the repository
TEMP_DIR="$COMFYUI_DIR/ReActor"

if [ ! -d "$TEMP_DIR/models" ]; then
  echo "Warning: Failed to clone ReActor repository or models directory not found"
  echo "Continuing with regular downloads..."
else
  # Copy inswapper models to insightface directory
  echo "Copying inswapper models..."
  cp "$TEMP_DIR/models/inswapper_128.onnx" "$COMFYUI_DIR/models/insightface/" 2>/dev/null || echo "Warning: inswapper_128.onnx not found"
  cp "$TEMP_DIR/models/inswapper_128_fp16.onnx" "$COMFYUI_DIR/models/insightface/" 2>/dev/null || echo "Warning: inswapper_128_fp16.onnx not found"

  # Copy reswapper models
  echo "Copying reswapper models..."
  if [ -f "$TEMP_DIR/models/reswapper_128.onnx" ]; then
    cp "$TEMP_DIR/models/reswapper_128.onnx" "$COMFYUI_DIR/models/reswapper/" 
  fi
  if [ -f "$TEMP_DIR/models/reswapper_256.onnx" ]; then
    cp "$TEMP_DIR/models/reswapper_256.onnx" "$COMFYUI_DIR/models/reswapper/"
  fi

  # Copy face restoration models
  echo "Copying face restoration models..."
  if [ -d "$TEMP_DIR/models/facerestore_models" ]; then
    cp "$TEMP_DIR/models/facerestore_models/"* "$COMFYUI_DIR/models/facerestore_models/" 2>/dev/null
  fi

  # Copy face detection model
  echo "Copying face detection model..."
  if [ -f "$TEMP_DIR/models/detection/bbox/face_yolov8m.pt" ]; then
    cp "$TEMP_DIR/models/detection/bbox/face_yolov8m.pt" "$COMFYUI_DIR/models/ultralytics/bbox/"
  fi

  # Copy SAM models
  echo "Copying SAM models..."
  if [ -d "$TEMP_DIR/models/sams" ]; then
    cp "$TEMP_DIR/models/sams/"* "$COMFYUI_DIR/models/sams/" 2>/dev/null
  fi

  # Extract buffalo_l.zip if needed for insightface
  echo "Extracting buffalo_l model..."
  if [ -f "$TEMP_DIR/models/buffalo_l.zip" ]; then
    unzip -o "$TEMP_DIR/models/buffalo_l.zip" -d "$COMFYUI_DIR/models/insightface/" || echo "Warning: Failed to extract buffalo_l.zip"
  fi

fi

show_progress "Download Complete!"
echo "All models have been downloaded to $COMFYUI_DIR/models/"
echo "IPAdapter models have been properly renamed for the Unified Loader."
echo "ReActor models have been installed."
echo "You can now start using ComfyUI with all the downloaded models."
